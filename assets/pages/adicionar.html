<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CONTROLE SUPPORT TI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="/assets/css/styles.css">
    <link rel="stylesheet" href="/assets/css/moblie.css">
    <link rel="stylesheet" href="/assets/css/adicionar.css">

</head>

<body>
    <section class="container-custom">
        <section class="cabecalho">



            <div class="mt-5"></div>
            <div class="d-flex flex-column flex-md-row justify-content-md-between align-items-center">
                <p class="text-header">Adicionar</p>
                
                <!-- Nova div com classes e conteúdo -->
                <div class="new-div-class">
                    <div class="dropdown">
                        <a class="btn btn-secondary dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <span class="selectedCategory" id="selectedCategory">Selecione uma categoria</span>
                        </a>
                        <ul class="dropdown-menu" id="categoriasDropdown">
                            <!-- Os itens da lista serão preenchidos dinamicamente aqui -->
                        </ul>
                    </div>
                </div>
                
                <div class="d-flex flex-column flex-md-row">
                   
                </div>
            </div>
            
            <hr class="line">
        </section>
        <!-- Modal -->
        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                
            </div>
        </div>
        </div>
        </div>
    
   
    <div class="positiondados">
        <div class="modal-content">
            <div class="modal-header">
               
            </div>
            <div class="modal-body" id="dynamicFields">
                <div style=" height: 70vh; overflow-y: scroll;">
                    <div id="tabelaCategoria" style="display: none;">
                        <form id="formCategoria">
                            <input type="hidden" id="categoria" name="categoria">
                            <div class="form-group" data-nome="categoria">
                                <label class="form-label">categoria:</label>
                                <input type="text" class="form-control" name="categoria">
                            </div>
                            <br>
                            <div id="camposCategoria">
                                
                                <!-- Os campos do formulário serão preenchidos dinamicamente aqui -->
                            </div>
                            <br>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div id="success_message" style="display: none;" class="alert alert-success" role="alert">
                    Item adicionado com sucesso!
                </div>
                <button type="button" class="btn btn-warning text-white" id="clear_form"
                    title="Limpar todos os campos preenchidos">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-eraser-fill" viewBox="0 0 16 16">
                        <path
                            d="M8.086 2.207a2 2 0 0 1 2.828 0l3.879 3.879a2 2 0 0 1 0 2.828l-5.5 5.5A2 2 0 0 1 7.879 15H5.12a2 2 0 0 1-1.414-.586l-2.5-2.5a2 2 0 0 1 0-2.828zm.66 11.34L3.453 8.254 1.914 9.793a1 1 0 0 0 0 1.414l2.5 2.5a1 1 0 0 0 .707.293H7.88a1 1 0 0 0 .707-.293z" />
                    </svg>
                </button>
                <button class="btn btn-success adicionarItemBtn" id="modalSaveButton" type="submit"
                    title="Adicionar sem apagar todos os campos preenchidos">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-pencil-fill" viewBox="0 0 16 16">
                        <path
                            d="M12.854.146a.5.5 0 0 0

-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11z" />
                    </svg>
                </button>
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-x-lg" viewBox="0 0 16 16">
                        <path
                            d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>
</section>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>



        





        <script>
            const dropdown = document.getElementById('categoriasDropdown');
            const selectedCategory = document.getElementById('selectedCategory');
            const tabelaCategoria = document.getElementById('tabelaCategoria');
            const formCategoria = document.getElementById('formCategoria');
            const camposCategoria = document.getElementById('camposCategoria');
        
            // Função para mostrar ou ocultar a tabela de categoria
            function mostrarTabelaCategoria(mostrar) {
                tabelaCategoria.style.display = mostrar ? 'block' : 'none';
            }
        
            // Use fetch para fazer uma solicitação AJAX para /categorias no seu servidor
            fetch('/categorias')
                .then(response => response.json()) // Converte a resposta para JSON
                .then(data => {
                    // Preenche o dropdown com as categorias obtidas do servidor
                    data.forEach(categoria => {
                        const listItem = document.createElement('li');
                        const link = document.createElement('a');
                        link.classList.add('dropdown-item'); // Adiciona a classe do Bootstrap
                        link.textContent = categoria;
                        link.href = '#'; // Adicione o link href desejado aqui
        
                        // Adiciona um ouvinte de evento de clique para cada item do menu suspenso
                        link.addEventListener('click', function () {
                            atualizarCategoriaSelecionada(categoria);
                        });
        
                        listItem.appendChild(link);
                        dropdown.appendChild(listItem);
                    });
                })
                .catch(error => {
                    console.error('Erro ao obter categorias:', error);
                });
        
            // Ouvinte de evento para o botão fora do formulário
            const adicionarItemBtn = document.querySelector('.adicionarItemBtn');
            adicionarItemBtn.addEventListener('click', function (event) {
                event.preventDefault(); // Previne o comportamento padrão do botão
        
                // Obtém o valor da categoria selecionada
                const categoriaSelecionada = document.getElementById('categoria').value;
        
                // Verifica se a categoria foi selecionada
                if (!categoriaSelecionada) {
                    console.error('Categoria não selecionada.');
                    return;
                }
        
                // Cria um objeto para armazenar os dados do formulário
                const formData = {};
        
                // Preenche o objeto com os dados do formulário
                const inputs = formCategoria.querySelectorAll('input');
                inputs.forEach(input => {
                    formData[input.name] = input.value;
                });
        
                // Limpar os campos do formulário, exceto o campo de categoria
                inputs.forEach(input => {
                    if (input.name !== 'categoria') {
                        input.value = '';
                    }
                });
        
                // Adiciona o valor da categoria ao objeto
                formData['categoria'] = categoriaSelecionada;
        
                // Envia os dados do formulário para o servidor
                fetch('/adicionarItem', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('ID do item adicionado:', data.id);
        
                        // Exibir mensagem de sucesso na div com ID "success_message"
                        const successMessageDiv = document.getElementById('success_message');
                        successMessageDiv.textContent = 'Item adicionado com sucesso!';
                        successMessageDiv.style.display = 'block';
        
                        // Remover a mensagem após 3 segundos
                        setTimeout(() => {
                            successMessageDiv.style.display = 'none';
                        }, 3000);
                    })
                    .catch(error => console.error('Erro ao adicionar item:', error));
            });
        
            // Função para ocultar o campo categoria assim que a página for carregada
            function ocultarCampoCategoria() {
                const categoriaInput = document.getElementById('categoria');
                if (!categoriaInput) {
                    console.error('Input "categoria" não encontrado.');
                } else {
                    categoriaInput.style.display = 'none';
                }
            }
        
            // Ocultar o campo categoria assim que a página for carregada
            ocultarCampoCategoria();
        
            // Função para atualizar o texto da categoria selecionada
            function atualizarCategoriaSelecionada(categoria) {
                selectedCategory.textContent = categoria;
                mostrarTabelaCategoria(false); // Oculta a tabela de categoria
        
                // Definir a categoria no campo oculto do formulário
                const categoriaInput = document.getElementById('categoria');
                if (categoriaInput) {
                    categoriaInput.value = categoria;
                } else {
                    console.error('Input "categoria" não encontrado.');
                }
        
                // Faz uma solicitação AJAX para obter os campos da categoria
                fetch(`/campos/${categoria}`)
                    .then(response => response.json())
                    .then(data => preencherCampos(data))
                    .catch(error => console.error('Erro ao obter campos da categoria:', error));
            }
        
            // Função para preencher os campos do formulário com base nos campos da tabela
            function preencherCampos(campos) {
                // Filtra os campos para excluir 'id' e 'categoria'
                const camposExcluidos = ['id', 'categoria', 'imagem'];
                const camposParaExibir = campos.filter(campo => !camposExcluidos.includes(campo));
        
                camposCategoria.innerHTML = '';
                
                let row;
                camposParaExibir.forEach((campo, index) => {
                    if (index % 2 === 0) {
                        row = document.createElement('div');
                        row.classList.add('row');
                        camposCategoria.appendChild(row);
                    }
        
                    const nomeCampoFormatado = campo.charAt(0).toUpperCase() + campo.slice(1).toLowerCase().split('_').join(' ');
        
                    const col = document.createElement('div');
                    col.classList.add('col-md-6'); // Usando col-md-6 para dois campos por linha
        
                    const formGroup = document.createElement('div');
                    formGroup.classList.add('form-group');
                    formGroup.dataset.nome = campo;
        
                    const label = document.createElement('label');
                    label.classList.add('form-label');
                    label.textContent = nomeCampoFormatado + ':'; // Adicionando o nome do campo formatado
        
                    const input = document.createElement('input');
                    input.setAttribute('type', 'text');
                    input.classList.add('form-control');
                    input.setAttribute('name', campo);
        
                    formGroup.appendChild(label);
                    formGroup.appendChild(input);
        
                    col.appendChild(formGroup);
                    row.appendChild(col);
                });
        
                // Adiciona o campo de upload de imagem fora do loop
                const campoImagemRow = document.createElement('div');
                campoImagemRow.classList.add('row');
        
                const campoImagemCol = document.createElement('div');
                campoImagemCol.classList.add('col-md-12');
        
                const campoImagem = document.createElement('div');
                campoImagem.classList.add('form-group');
                campoImagem.dataset.nome = 'imagem';
        
                const labelImagem = document.createElement('label');
                labelImagem.setAttribute('for', 'imagem');
                labelImagem.textContent = 'Imagem:';
                labelImagem.classList.add('form-label');
        
                const inputImagem = document.createElement('input');
                inputImagem.setAttribute('type', 'file');
                inputImagem.setAttribute('id', 'imagem');
                inputImagem.setAttribute('name', 'imagem');
                inputImagem.setAttribute('accept', 'image/*');
                inputImagem.classList.add('form-control');
        
                campoImagem.appendChild(labelImagem);
                campoImagem.appendChild(inputImagem);
                campoImagemCol.appendChild(campoImagem);
                campoImagemRow.appendChild(campoImagemCol);
                camposCategoria.appendChild(campoImagemRow);
        
                mostrarTabelaCategoria(true);
            }
        </script>
        
        



</body>

</html>